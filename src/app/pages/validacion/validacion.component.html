<div class="validacion-container">
	<div class="validacion-header">
		<h2>Validaci√≥n de C√≥digos QR</h2>
		<p-button 
			label="Volver al Panel" 
			icon="pi pi-arrow-left"
			(onClick)="volver()"
			styleClass="btn-back p-button-secondary"
		></p-button>
	</div>

	<div class="scanner-section">
		<!-- Pesta√±as -->
		<div class="tabs">
			<button 
				class="tab" 
				[class.active]="modoEscaneo === 'camara'"
				(click)="cambiarModo('camara')">
				Escanear con C√°mara
			</button>
			<button 
				class="tab" 
				[class.active]="modoEscaneo === 'manual'"
				(click)="cambiarModo('manual')">
				Ingreso Manual
			</button>
		</div>

		<!-- Modo C√°mara -->
		<div *ngIf="modoEscaneo === 'camara'" class="camera-container">
			<div class="camera-header">
				<p class="camera-status">
					<span *ngIf="!camaraIniciada" class="status-waiting">‚è≥ Iniciando c√°mara...</span>
					<span *ngIf="camaraIniciada && !validando" class="status-ready">‚úì C√°mara lista - Apunta al c√≥digo QR</span>
					<span *ngIf="validando" class="status-scanning">üîç Validando c√≥digo...</span>
				</p>
			</div>

			<div class="scanner-wrapper">
				<zxing-scanner
					*ngIf="camaraActiva"
					[device]="camaraSeleccionada"
					(scanSuccess)="onScanSuccess($event)"
					(camerasFound)="onCamerasFound($event)"
					(permissionResponse)="onPermissionResponse($event)"
					[formats]="formatosPermitidos"
					[tryHarder]="true"
					class="qr-scanner">
				</zxing-scanner>

				<div *ngIf="!camaraActiva && !errorCamara" class="scanner-placeholder">
					<p>üì∑ Preparando c√°mara...</p>
				</div>

				<div *ngIf="errorCamara" class="scanner-error">
					<p>‚ùå Error al acceder a la c√°mara</p>
					<small>{{ errorCamara }}</small>
					<p-button 
						label="Reintentar" 
						icon="pi pi-refresh"
						(onClick)="reiniciarCamara()"
						styleClass="btn-retry p-button-warning"
					></p-button>
				</div>
			</div>

			<div class="camera-controls" *ngIf="camarasDisponibles.length > 1">
				<label for="cameraSelect">Seleccionar c√°mara:</label>
				<p-dropdown 
					id="cameraSelect"
					[options]="camarasDisponibles" 
					[(ngModel)]="camaraSeleccionada"
					(onChange)="cambiarCamara()"
					optionLabel="label"
					placeholder="Seleccione una c√°mara"
					styleClass="camera-dropdown"
				></p-dropdown>
			</div>

			<div class="instrucciones">
				<p>üí° <strong>Instrucciones:</strong></p>
				<ul>
					<li>Apunta la c√°mara al c√≥digo QR del participante</li>
					<li>Mant√©n el c√≥digo dentro del √°rea de escaneo</li>
					<li>El sistema validar√° autom√°ticamente al detectar el c√≥digo</li>
				</ul>
			</div>
		</div>

		<!-- Modo Manual -->
		<div *ngIf="modoEscaneo === 'manual'" class="manual-container">
			<div class="input-group">
				<label for="qrInput">Ingresa el c√≥digo QR:</label>
				<input 
					type="text" 
					id="qrInput"
					pInputText
					[(ngModel)]="codigoQR"
					(keyup.enter)="validarCodigo()"
					placeholder="Pega o escribe el c√≥digo QR aqu√≠"
					autofocus
				/>
				<p-button 
					label="{{ validando ? 'Validando...' : 'Validar' }}" 
					icon="pi pi-check"
					(onClick)="validarCodigo()" 
					[disabled]="!codigoQR || validando"
					styleClass="btn-validar p-button-success"
				></p-button>
			</div>

			<div class="instrucciones">
				<p>üí° <strong>Instrucciones:</strong></p>
				<ul>
					<li>Pega el c√≥digo QR en el campo de texto</li>
					<li>O escr√≠belo manualmente</li>
					<li>Presiona Enter o el bot√≥n Validar</li>
				</ul>
			</div>
		</div>
	</div>

	<!-- Modal de Resultado -->
	<div *ngIf="mostrarModal" class="modal-overlay" (click)="cerrarModal()">
		<div class="modal-content" (click)="$event.stopPropagation()" [ngClass]="resultado?.valido ? 'modal-exito' : 'modal-error'">
			<div class="modal-icon">
				{{ resultado?.valido ? '‚úÖ' : '‚ùå' }}
			</div>
			<h2 class="modal-titulo">{{ resultado?.titulo }}</h2>
			<p class="modal-mensaje">{{ resultado?.mensaje }}</p>
			
			<div *ngIf="resultado?.valido && resultado?.datos" class="modal-datos">
				<div class="datos-grid">
					<div class="dato-item">
						<span class="dato-label">Nombre:</span>
						<span class="dato-valor">{{ resultado?.datos?.nombreCompleto }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">Email:</span>
						<span class="dato-valor">{{ resultado?.datos?.email }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">Tipo de Veh√≠culo:</span>
						<span class="dato-valor">{{ resultado?.datos?.tipoVehiculo }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">Placa:</span>
						<span class="dato-valor">{{ resultado?.datos?.placa }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">Tem√°tica:</span>
						<span class="dato-valor">{{ resultado?.datos?.tematica }}</span>
					</div>
				</div>
			</div>

			<div *ngIf="!resultado?.valido && resultado?.datos" class="modal-datos">
				<div class="datos-grid">
					<div class="dato-item">
						<span class="dato-label">Nombre:</span>
						<span class="dato-valor">{{ resultado?.datos?.nombreCompleto }}</span>
					</div>
					<div class="dato-item" *ngIf="resultado?.datos?.validadoAt">
						<span class="dato-label">Validado el:</span>
						<span class="dato-valor">{{ resultado?.datos?.validadoAt?.toDate() | date:'dd/MM/yyyy HH:mm' }}</span>
					</div>
					<div class="dato-item" *ngIf="resultado?.datos?.validadoPor">
						<span class="dato-label">Validado por:</span>
						<span class="dato-valor">{{ resultado?.datos?.validadoPor }}</span>
					</div>
				</div>
			</div>
			
			<p-button 
				label="Aceptar" 
				icon="pi pi-check"
				(onClick)="cerrarModal()"
				styleClass="btn-modal-cerrar"
				[styleClass]="resultado?.valido ? 'btn-modal-cerrar p-button-success' : 'btn-modal-cerrar p-button-danger'"
			></p-button>
		</div>
	</div>

	<!-- Historial de validaciones -->
	<div *ngIf="historial.length" class="historial-section">
		<h3>Historial de Validaciones</h3>
		<div class="historial-lista">
			<div *ngFor="let item of historial" class="historial-item" [ngClass]="item.valido ? 'historial-exito' : 'historial-error'">
				<div class="historial-icon">{{ item.valido ? '‚úÖ' : '‚ùå' }}</div>
				<div class="historial-info">
					<strong>{{ item.datos?.nombreCompleto || 'C√≥digo inv√°lido' }}</strong>
					<small>{{ item.hora | date:'HH:mm:ss' }} - {{ item.mensaje }}</small>
				</div>
			</div>
		</div>
	</div>
</div>
