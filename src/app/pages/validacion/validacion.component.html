<div class="validacion-container">
	<div class="validacion-header">
		<h2>ğŸ¯ ValidaciÃ³n de CÃ³digos QR</h2>
		<button class="btn-back" (click)="volver()">â† Volver al Panel</button>
	</div>

	<div class="scanner-section">
		<!-- PestaÃ±as -->
		<div class="tabs">
			<button 
				class="tab" 
				[class.active]="modoEscaneo === 'camara'"
				(click)="cambiarModo('camara')">
				ğŸ“· Escanear con CÃ¡mara
			</button>
			<button 
				class="tab" 
				[class.active]="modoEscaneo === 'manual'"
				(click)="cambiarModo('manual')">
				âŒ¨ï¸ Ingreso Manual
			</button>
		</div>

		<!-- Modo CÃ¡mara -->
		<div *ngIf="modoEscaneo === 'camara'" class="camera-container">
			<div class="camera-header">
				<p class="camera-status">
					<span *ngIf="!camaraIniciada" class="status-waiting">â³ Iniciando cÃ¡mara...</span>
					<span *ngIf="camaraIniciada && !validando" class="status-ready">âœ“ CÃ¡mara lista - Apunta al cÃ³digo QR</span>
					<span *ngIf="validando" class="status-scanning">ğŸ” Validando cÃ³digo...</span>
				</p>
			</div>

			<div class="scanner-wrapper">
				<zxing-scanner
					*ngIf="camaraActiva"
					[device]="camaraSeleccionada"
					(scanSuccess)="onScanSuccess($event)"
					(camerasFound)="onCamerasFound($event)"
					(permissionResponse)="onPermissionResponse($event)"
					[formats]="formatosPermitidos"
					[tryHarder]="true"
					class="qr-scanner">
				</zxing-scanner>

				<div *ngIf="!camaraActiva && !errorCamara" class="scanner-placeholder">
					<p>ğŸ“· Preparando cÃ¡mara...</p>
				</div>

				<div *ngIf="errorCamara" class="scanner-error">
					<p>âŒ Error al acceder a la cÃ¡mara</p>
					<small>{{ errorCamara }}</small>
					<button class="btn-retry" (click)="reiniciarCamara()">ğŸ”„ Reintentar</button>
				</div>
			</div>

			<div class="camera-controls" *ngIf="camarasDisponibles.length > 1">
				<label for="cameraSelect">Seleccionar cÃ¡mara:</label>
				<select id="cameraSelect" [(ngModel)]="camaraSeleccionada" (change)="cambiarCamara()">
					<option *ngFor="let cam of camarasDisponibles" [ngValue]="cam">
						{{ cam.label || 'CÃ¡mara ' + (camarasDisponibles.indexOf(cam) + 1) }}
					</option>
				</select>
			</div>

			<div class="instrucciones">
				<p>ğŸ’¡ <strong>Instrucciones:</strong></p>
				<ul>
					<li>Apunta la cÃ¡mara al cÃ³digo QR del participante</li>
					<li>MantÃ©n el cÃ³digo dentro del Ã¡rea de escaneo</li>
					<li>El sistema validarÃ¡ automÃ¡ticamente al detectar el cÃ³digo</li>
				</ul>
			</div>
		</div>

		<!-- Modo Manual -->
		<div *ngIf="modoEscaneo === 'manual'" class="manual-container">
			<div class="input-group">
				<label for="qrInput">Ingresa el cÃ³digo QR:</label>
				<input 
					type="text" 
					id="qrInput"
					[(ngModel)]="codigoQR"
					(keyup.enter)="validarCodigo()"
					placeholder="Pega o escribe el cÃ³digo QR aquÃ­"
					autofocus
				/>
				<button class="btn-validar" (click)="validarCodigo()" [disabled]="!codigoQR || validando">
					{{ validando ? 'Validando...' : 'âœ“ Validar' }}
				</button>
			</div>

			<div class="instrucciones">
				<p>ğŸ’¡ <strong>Instrucciones:</strong></p>
				<ul>
					<li>Pega el cÃ³digo QR en el campo de texto</li>
					<li>O escrÃ­belo manualmente</li>
					<li>Presiona Enter o el botÃ³n Validar</li>
				</ul>
			</div>
		</div>
	</div>

	<!-- Modal de Resultado -->
	<div *ngIf="mostrarModal" class="modal-overlay" (click)="cerrarModal()">
		<div class="modal-content" (click)="$event.stopPropagation()" [ngClass]="resultado?.valido ? 'modal-exito' : 'modal-error'">
			<div class="modal-icon">
				{{ resultado?.valido ? 'âœ…' : 'âŒ' }}
			</div>
			<h2 class="modal-titulo">{{ resultado?.titulo }}</h2>
			<p class="modal-mensaje">{{ resultado?.mensaje }}</p>
			
			<div *ngIf="resultado?.valido && resultado?.datos" class="modal-datos">
				<div class="datos-grid">
					<div class="dato-item">
						<span class="dato-label">Nombre:</span>
						<span class="dato-valor">{{ resultado?.datos?.nombreCompleto }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">Email:</span>
						<span class="dato-valor">{{ resultado?.datos?.email }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">Tipo de VehÃ­culo:</span>
						<span class="dato-valor">{{ resultado?.datos?.tipoVehiculo }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">Placa:</span>
						<span class="dato-valor">{{ resultado?.datos?.placa }}</span>
					</div>
					<div class="dato-item">
						<span class="dato-label">TemÃ¡tica:</span>
						<span class="dato-valor">{{ resultado?.datos?.tematica }}</span>
					</div>
				</div>
			</div>

			<div *ngIf="!resultado?.valido && resultado?.datos" class="modal-datos">
				<div class="datos-grid">
					<div class="dato-item">
						<span class="dato-label">Nombre:</span>
						<span class="dato-valor">{{ resultado?.datos?.nombreCompleto }}</span>
					</div>
					<div class="dato-item" *ngIf="resultado?.datos?.validadoAt">
						<span class="dato-label">Validado el:</span>
						<span class="dato-valor">{{ resultado?.datos?.validadoAt?.toDate() | date:'dd/MM/yyyy HH:mm' }}</span>
					</div>
					<div class="dato-item" *ngIf="resultado?.datos?.validadoPor">
						<span class="dato-label">Validado por:</span>
						<span class="dato-valor">{{ resultado?.datos?.validadoPor }}</span>
					</div>
				</div>
			</div>
			
			<button class="btn-modal-cerrar" (click)="cerrarModal()">Aceptar</button>
		</div>
	</div>

	<!-- Historial de validaciones -->
	<div *ngIf="historial.length" class="historial-section">
		<h3>ğŸ“‹ Historial de Validaciones (SesiÃ³n Actual)</h3>
		<div class="historial-lista">
			<div *ngFor="let item of historial" class="historial-item" [ngClass]="item.valido ? 'historial-exito' : 'historial-error'">
				<div class="historial-icon">{{ item.valido ? 'âœ…' : 'âŒ' }}</div>
				<div class="historial-info">
					<strong>{{ item.datos?.nombreCompleto || 'CÃ³digo invÃ¡lido' }}</strong>
					<small>{{ item.hora | date:'HH:mm:ss' }} - {{ item.mensaje }}</small>
				</div>
			</div>
		</div>
	</div>
</div>
